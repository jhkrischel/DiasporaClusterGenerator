<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
		
		<title>Diaspora Cluster Editor</title>

		<link href='http://fonts.googleapis.com/css?family=Aldrich' rel='stylesheet' type='text/css'>
        <link href="./css/diaspora.css" rel="stylesheet"/>

		<script type="text/javascript" src="./scripts/jquery-1.9.0.js"></script>
		<script type="text/javascript" src="./scripts/jcanvas.js"></script>
		<script type="text/javascript" src="./scripts/knockout-2.3.0.js"></script>		
		<script type="text/javascript" src="./scripts/seedrandom.js"></script>
		<script type="text/javascript" src="./scripts/dice.js"></script>
		<script type="text/javascript" src="./scripts/cluster.js"></script>
	</head>
	<body>
		<h1>Diaspora Cluster Editor</h1>
		
		<br />
		<canvas id="clusterCanvas" width="500" height="250"></canvas>
		<hr />
		<div id="instructions">
			<h2>Click a system to begin</h2>
			Still a work in progress
		</div>
		<div id="systemBlock" data-bind="foreach: systems">
			<div id="system" data-bind="attr: {id: $index }" >
				<label for="systemName">System Name</label><input  data-bind="value: name" type="text" id="systemName" /><br />
				<label for="technology">Technology</label>
				<select id="technology" data-bind="value: planet.technology">
					<option>4</option>
					<option>3</option>
					<option>2</option>
					<option>1</option>
					<option>0</option>
					<option>-1</option>
					<option>-2</option>
					<option>-3</option>
					<option>-4</option>
				</select><br />
				<label for="environment">Environment</label>
				<select id="environment" data-bind="value: planet.environment">
					<option>4</option>
					<option>3</option>
					<option>2</option>
					<option>1</option>
					<option>0</option>
					<option>-1</option>
					<option>-2</option>
					<option>-3</option>
					<option>-4</option>
				</select><br />
				<label for="resources">Resources</label>
				<select id="resources" data-bind="value: planet.resources">
					<option>4</option>
					<option>3</option>
					<option>2</option>
					<option>1</option>
					<option>0</option>
					<option>-1</option>
					<option>-2</option>
					<option>-3</option>
					<option>-4</option>
				</select><br />
				<label for="aspect1">Aspect</label><input data-bind="value: aspect1" type="text" id="aspect1" /><br />
				<label for="aspect2">Aspect</label><input data-bind="value: aspect2" type="text" id="aspect2" /><br />		
			</div>
		</div>
		<br />

		<div id="clusterJSON"></div>
		<hr />
		<div id="koJSON"></div>
        <script type="text/javascript">		
			$.urlParam = function(name){
				var results = new RegExp('[\\?&amp;]' + name + '=([^&amp;#]*)').exec(window.location.href);
				return results[1] || 0;
			}

			var QueryString = function () {
				// This function is anonymous, is executed immediately and 
				// the return value is assigned to QueryString!
				var query_string = {};
				var query = window.location.search.substring(1);
				var vars = query.split("&");
				for (var i=0;i<vars.length;i++) {
					var pair = vars[i].split("=");
					// If first entry with this name
					if (typeof query_string[pair[0]] === "undefined") {
						query_string[pair[0]] = pair[1];
						// If second entry with this name
					} else if (typeof query_string[pair[0]] === "string") {
						var arr = [ query_string[pair[0]], pair[1] ];
						query_string[pair[0]] = arr;
						// If third or later entry with this name
					} else {
						query_string[pair[0]].push(pair[1]);
					}
				} 
				return query_string;
			} ();
			
			var ClusterEditModel = function(systems) {
				var self = this;
				self.systems = ko.observableArray(systems);
								
			};
			
			var cluster = new Cluster();
			
			$(document).ready(function () {
				//var jsonCluster = $.urlParam('json');
				var jsonCluster = QueryString.json;
				jsonCluster = decodeURIComponent(jsonCluster);
				cluster.LoadFromJSON(jsonCluster);
				cluster.Draw("#clusterCanvas");
				//$("#clusterJSON").html(jsonCluster);
				
				var model = new ClusterEditModel(cluster.systems)
				$("#koJSON").html(ko.toJSON(model));
				ko.applyBindings(model);
				
				$("#systemBlock").children("div").hide();
				
				$( "select" ).change(function() {
					cluster.Draw("#clusterCanvas");
					$("#koJSON").html(ko.toJSON(model));
				});

				$( "input" ).change(function() {
					cluster.Draw("#clusterCanvas");
					$("#koJSON").html(ko.toJSON(model));
				});
				
            });
			
        </script>
		<div id="footer">
			<a href="https://github.com/thecrazygm/DiasporaClusterGenerator">Get the Source Code Here</a>
		</div>
	</body>
</html>